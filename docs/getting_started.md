# Getting Started

1. [Introduction](#introduction-to-ansible-playbook-bundles-apbs)

2. [Development Environment](#development-environment)

3. [Creating Your First APB](#creating-your-first-apb)
    1. [Init](#using-apb-init)
    2. [Actions](#actions)
        * [Provision](#provision)
        * [Bind](#bind)
        * [Unbind](#unbind)
        * [Deprovision](#deprovision)

4. [More Information](#more-information)

## Introduction to Ansible Playbook Bundles (APBs)

In this tutorial, we'll walk through the creation of a APB for a PostgreSQL database.  You will be able to provision, deprovision, and bind or unbind it to other applications.  You can find more information about the design of APBs in the [design doc](https://github.com/fusor/ansible-playbook-bundle/blob/master/docs/design.md)


## Development Environment
Before getting started with APBs, we need to get your system set up to create them.

First, install the APB tools as documented in the [README](https://github.com/fusor/ansible-playbook-bundle/tree/docs#install).  You should be able to run the `apb help` and get a valid response.
```
$ apb help
usage: apb [-h] [--debug] [--project BASE_PATH] {init,help,prepare,build} ...

APB tooling forassisting in building and packaging APBs.

optional arguments:
  -h, --help            show this help message and exit
  --debug               Enable debug output
  --project BASE_PATH, -p BASE_PATH
                        Specify a path to your project. Defaults to CWD.

subcommand:
  {init,help,prepare,build}
    init                Initialize the directory for APB development
    help                Display this help message
    prepare             Prepare an ansible-container project for APB packaging
    build               Build and package APB container
```

Next, create a local development environment with both a [Service Catalog](https://github.com/kubernetes-incubator/service-catalog) and [Ansible Service Broker](https://github.com/fusor/ansible-service-broker).  We will do this using [catasb](https://github.com/fusor/catasb), a collection of scripts which use Ansible to automate the set up of the cluster for you on a local host, ec2, or virtual machines.  For this tutorial we'll be assuming the locally hosted environment which is documented at [https://github.com/fusor/catasb/blob/master/local/README.md](https://github.com/fusor/catasb/blob/master/local/README.md).  After completing the set up, take note of the OpenShift cluster **host:port** output by the catasb Ansible scripts so you can login using the command line for the remainder of the tutorial.  It will look something like:

```
$ ./run_setup_local.sh # or ./reset_environment.sh

...snip...

TASK [debug] *********************************************************************************************************************************
ok: [localhost] => {
    "changed": false,
    "msg": [
        "Hostname: <catasb-host>",
        "Next steps:",
        "1) Visit https://apiserver-service-catalog.<catasb-host>",
        "2) Accept the certificate",
        "3) Visit https://<catasb-host>:<port> for the console",
        "OR",
        "For CLI access:",
        "oc login --insecure-skip-tls-verify <catasb-host>:<port> -u admin -p admin",
        ""
    ]
}
```

Test out your development environment using [apb-examples](https://github.com/fusor/apb-examples):

```
git clone git@github.com:fusor/apb-examples.git
cd hello-world-apb
apb prepare
docker build -t <docker-user>/hello-world-apb .
docker run -e "OPENSHIFT_TARGET=https://<catasb-host>:<port>" -e "OPENSHIFT_USER=admin" -e "OPENSHIFT_PASS=admin" <docker-user>/hello-world-apb provision
```
This will deploy a hello-world-apb application to your openshift cluster.  By logging on to your cluster at https://<catasb-host>:<port>, you can view the project and click on the deployed application.

## Creating your first APB
In this tutorial we'll create a simple PostgreSQL database.

### Using apb init
Our first task is to create the skeleton for your app using the apb tool.  The command for this is simple:
```
apb init pg-apb
```
At this point you should see the following file structure
```
pg-apb/
├── apb.yml
├── Dockerfile
├── playbooks
└── roles
```
Two files were created at the root directory, an `apb.yml` and a `Dockerfile`.  These are the minimum required for any APB.  For more information, visit the [design doc](https://github.com/fusor/ansible-playbook-bundle/blob/master/docs/design.md#apb-yml).
```yaml
# apb.yml

id: d05...44b
name: sample-apb
image: organization/sample-apb
description: "This is a sample skeleton file generated by `apb init`."
bindable: false
async: optional
parameters:
  - name: sample_param
    description: Sample description of APB
    type: string
    default: sample-param-string
```
```dockerfile
# Dockerfile

FROM ansibleplaybookbundle/apb-base
# MAINTAINER {{ $MAINTAINER }}

LABEL "com.redhat.apb.version"="0.1.0"
LABEL "com.redhat.apb.spec"=\
"aWQ6IGQw....mluZwo="

USER apb
```

At this point we have a fully formed APB that we can build
```
cd pg-apb
apb prepare
docker build -t <docker-user>/pg-apb .
docker push <docker-user>/pg-apb
```

Visiting the OpenShift console UI at https://<catasb-host>:<port> will now display the new Ansible Playbook bundle named pg-apb in the catalog under the **_All_** tab.

### Actions
The brand new APB created in the last section doesn't do very much.  For that, we'll have to add some actions.  The actions supported are [provision](#provision), [deprovision](#deprovision), [bind](#bind), and [unbind](#unbind).  We'll add each of these actions in the following sections

#### Provision

#### Bind

#### Unbind

#### Deprovision

### More information
